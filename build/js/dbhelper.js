"use strict";var _createClass=function(){function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}();function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function u(){_classCallCheck(this,u)}return _createClass(u,null,[{key:"openDB",value:function(){return"indexedDB"in window?idb.open("Restaurants Reviews",1,function(e){e.objectStoreNames.contains(u.RESTAURANT_STORE)||(e.createObjectStore(u.RESTAURANT_STORE,{keyPath:"id"}).createIndex("id","id"),e.createObjectStore(u.REVIEW_STORE,{keyPath:"id"}).createIndex("id","id"),e.createObjectStore(u.OFFLINE_STORE,{keyPath:"createdAt"}).createIndex("restaurant_id","restaurant_id"))}):null}},{key:"fetchRestaurants",value:function(n){u.getAllRestaurants().then(function(e){n(null,e),u.saveRestaurantLocally(e).then(function(e){console.log("Fetched all restaurants data from server")}).catch(function(e){console.error("Failed to save restaurants locally: "+e.stack)})}).catch(function(e){console.log("Unable to fetch restaurants from server: "+e.stack),u.getSavedRestaurantData().then(function(e){n(null,e)})})}},{key:"getAllRestaurants",value:function(){return new Promise(function(n,t){u.getServerData(u.DATABASE_URL+"/restaurants").then(function(e){return n(e)}).catch(function(e){return t(e)})})}},{key:"getRestaurantById",value:function(e){return new Promise(function(n,t){u.getServerData(u.DATABASE_URL+"/restaurants/"+e).then(function(e){return n(e)}).catch(function(e){return t(e)})})}},{key:"getRestaurantReviewById",value:function(e){return new Promise(function(n,t){u.getServerData(u.DATABASE_URL+"/reviews/?restaurant_id="+e).then(function(e){return n(e)}).catch(function(e){return t(e)})})}},{key:"addReview",value:function(r){return new Promise(function(t,n){u.mutateData(u.DATABASE_URL+"/reviews/","POST",r).then(function(n){console.info("Successfully submitted review"),u.saveRestaurantReviews(n,u.REVIEW_STORE).then(function(e){return console.info("Review saved for offline use"),t(n)}).catch(function(e){return console.error("Failed to save review: "+e.stack),t(n)})}).catch(function(e){console.info("No internet, failed to upload review: "+e.stack),u.saveRestaurantReviews(r,u.OFFLINE_STORE).then(function(e){return console.log("Review will be uploaded automatically when connected to internet"),Snackbar.show({text:"Not connected, Review will be uploaded once re-connected!",actionText:"OK",textColor:"#fff",actionTextColor:"#f44336",pos:"bottom-center"}),t(r)}).catch(function(e){return console.error("Failed to save review: "+e.stack),n(e)})})})}},{key:"mutateData",value:function(e,r,o){return new Promise(function(n,t){fetch(e,{method:r,body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()}).then(function(e){return n(e)}).catch(function(e){return console.log("1",e.stack),t(e)})})}},{key:"fetchRestaurantReviews",value:function(n,t){u.getRestaurantReviewById(n.id).then(function(e){t(null,e),u.saveRestaurantReviews(e,u.REVIEW_STORE).then(function(e){console.log("Review from Server")}).catch(function(e){console.error("Failed to save review locally: "+e.stack)})}).catch(function(e){console.log("Unable to fetch review from server: "+e.stack),Snackbar.show({text:"You lost connection.",actionText:"OK",actionTextColor:"#f44336",textColor:"#fff",pos:"bottom-center"}),u.getSavedReview(n.id).then(function(e){t(null,e)})})}},{key:"getSavedReview",value:function(t){return new Promise(function(e,n){return"indexedDB"in window?e(t?u.openDB().then(function(e){return e.transaction(u.REVIEW_STORE,"readonly").objectStore(u.REVIEW_STORE).get(t)}):u.openDB().then(function(e){return e.transaction(u.REVIEW_STORE,"readonly").objectStore(u.REVIEW_STORE).getAll()})):n(null)})}},{key:"getServerData",value:function(e){return new Promise(function(n,t){fetch(e,{mode:"cors"}).then(function(e){return e.ok?n(e.json()):t(Error(e.statusText))}).catch(function(e){return console.log("Request failed",e.stack),t(e)})})}},{key:"saveRestaurantLocally",value:function(r){if(!Array.isArray(r)){var e=[];e.push(r),r=e}return new Promise(function(e,n){return"indexedDB"in window?e(u.openDB().then(function(e){var n=e.transaction(u.RESTAURANT_STORE,"readwrite"),t=n.objectStore(u.RESTAURANT_STORE);return Promise.all(r.map(function(e){return t.put(e)})).catch(function(){throw n.abort(),Error("Restaurants were not added to the store")}).then(function(){console.log("Restaurants added to DB")})})):n(null)})}},{key:"saveRestaurantReviews",value:function(r,o){if(!Array.isArray(r)){var e=[];e.push(r),r=e}return new Promise(function(e,n){return"indexedDB"in window?e(u.openDB().then(function(e){var n=e.transaction(o,"readwrite"),t=n.objectStore(o);return Promise.all(r.map(function(e){return t.put(e)})).catch(function(){throw n.abort(),Error("Reviews were not added to the "+o)}).then(function(){console.log("Reviews added to DB")})})):n(null)})}},{key:"getSavedRestaurantData",value:function(t){return new Promise(function(e,n){return"indexedDB"in window?e(t?u.openDB().then(function(e){return e.transaction(u.RESTAURANT_STORE,"readonly").objectStore(u.RESTAURANT_STORE).get(t)}):u.openDB().then(function(e){return e.transaction(u.RESTAURANT_STORE,"readonly").objectStore(u.RESTAURANT_STORE).getAll()})):n(null)})}},{key:"fetchRestaurantById",value:function(r,o){u.fetchRestaurants(function(e,n){if(e)o(e,null);else{var t=n.find(function(e){return e.id==r});t?o(null,t):o("Restaurant does not exist",null)}})}},{key:"fetchRestaurantByCuisine",value:function(r,o){u.fetchRestaurants(function(e,n){if(e)o(e,null);else{var t=n.filter(function(e){return e.cuisine_type==r});o(null,t)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,o){u.fetchRestaurants(function(e,n){if(e)o(e,null);else{var t=n.filter(function(e){return e.neighborhood==r});o(null,t)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,o,a){u.fetchRestaurants(function(e,n){if(e)a(e,null);else{var t=n;"all"!=r&&(t=t.filter(function(e){return e.cuisine_type==r})),"all"!=o&&(t=t.filter(function(e){return e.neighborhood==o})),a(null,t)}})}},{key:"fetchNeighborhoods",value:function(o){u.fetchRestaurants(function(e,t){if(e)o(e,null);else{var r=t.map(function(e,n){return t[n].neighborhood}),n=r.filter(function(e,n){return r.indexOf(e)==n});o(null,n)}})}},{key:"fetchCuisines",value:function(o){u.fetchRestaurants(function(e,t){if(e)o(e,null);else{var r=t.map(function(e,n){return t[n].cuisine_type}),n=r.filter(function(e,n){return r.indexOf(e)==n});o(null,n)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return e.id}},{key:"mapMarkerForRestaurant",value:function(e,n){var t=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:u.urlForRestaurant(e)});return t.addTo(newMap),t}},{key:"syncOutBoxData",value:function(){return new Promise(function(e,n){return"indexedDB"in window?e(u.openDB().then(function(e){return e.transaction(u.OFFLINE_STORE,"readonly").objectStore(u.OFFLINE_STORE).getAll()})):n(null)})}},{key:"clearOutBoxData",value:function(t){return new Promise(function(e,n){return"indexedDB"in window?e(u.openDB().then(function(e){return e.transaction(u.OFFLINE_STORE,"readwrite").objectStore(u.OFFLINE_STORE).delete(t)})):n(null)})}},{key:"RESTAURANT_STORE",get:function(){return"Restaurants"}},{key:"REVIEW_STORE",get:function(){return"Reviews"}},{key:"OFFLINE_STORE",get:function(){return"Outbox"}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337"}}]),u}();