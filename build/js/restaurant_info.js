"use strict";function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(o,i){return function t(e,n){try{var a=s[e](n),r=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(r).then(function(e){t("next",e)},function(e){t("throw",e)});o(r)}("next")})}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var newMap,restaurant=void 0,MAPBOX_API_KEY="pk.eyJ1IjoiaXN0aWFxdWUxOCIsImEiOiJjampjbzhxYnEyM3ZlM3Z0ZWRncHVsOXEyIn0.G92w014uYkp64EiGScJH8Q",isConnected=navigator.onLine;document.addEventListener("DOMContentLoaded",function(e){isConnected||showToast("Viewing content in offline!!"),initMap()});var initMap=function(){fetchRestaurantFromURL(function(e,t){e?console.error(e):(self.newMap=L.map("map",{center:[t.latlng.lat,t.latlng.lng],zoom:16,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:MAPBOX_API_KEY,maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.newMap))})},fetchRestaurantFromURL=function(o){if(self.restaurant)o(null,self.restaurant);else{var i=getParameterByName("id");if(i)DBHelper.fetchRestaurantById(i,function(e,r){(self.restaurant=r)?DBHelper.fetchRestaurantReviews(self.restaurant,function(n,a){DBHelper.syncOutBoxData().then(function(e){if(0<e.length){var t=e.filter(function(e){return-1<Object.keys(e).indexOf("is_favorite")});0<t.length&&t.forEach(function(e){e.id===i&&(self.restaurant=e)}),e=e.filter(function(e){return-1===Object.keys(e).indexOf("is_favorite")}),a.push.apply(a,_toConsumableArray(e))}self.reviews=a.reverse(),a||console.error(n),fillRestaurantHTML(),o(null,r)}).catch(function(e){console.error("outBoxData",e.stack)})}):console.error(e)});else{o("No restaurant id in URL",null)}}},fillRestaurantHTML=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant;document.getElementById("restaurant-name").innerHTML=t.name;var n="true"===t.is_favorite||!0===t.is_favorite,a=document.querySelector(".btn_favourite");a.id="btn_favourite_"+t.id,a.className="btn_favourite"+(n?" isFavourite":""),a.setAttribute("aria-label",n?"Mark "+t.name+" restaurant as not favourite":"Mark "+t.name+" restaurant as favourite"),a.setAttribute("aria-pressed",n),a.addEventListener("click",function(e){isConnected||showToast("Not connected, Your action will be updated once re-connected!"),a.classList.toggle("isFavourite"),n=a.classList.contains("isFavourite"),a.setAttribute("aria-label",n?"Mark "+t.name+" restaurant as not favourite":"Mark "+t.name+" restaurant as favourite"),a.setAttribute("aria-pressed",n),t.is_favorite=n,DBHelper.toggleFavBtn(t).then(function(e){console.info("Updated your favourite restaurant: "+JSON.stringify(e))}).catch(function(e){console.error("Failed updating favourite restaurant: "+e.stack),showToast("Failed to save restaurant data")})});var e=document.getElementById("restaurant-address");e.innerHTML=t.address,e.setAttribute("aria-label","restaurant address "+t.address);var r=document.getElementById("restaurant-img"),o=DBHelper.imageUrlForRestaurant(t);r.className="restaurant-img",r.src="/build/img/"+o+".webp",r.srcset="/build/img/"+o+".webp 1x, /build/img/"+o+".jpg 2x",document.getElementById("restaurant-cuisine").innerHTML=t.cuisine_type,r.alt="Image of restaurant name "+t.name+", cuisine type "+t.cuisine_type,t.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()},fillRestaurantHoursHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,t=document.getElementById("restaurant-hours");for(var n in e){var a=document.createElement("tr"),r=document.createElement("td");r.innerHTML=n,a.appendChild(r);var o=document.createElement("td");o.innerHTML=e[n],a.tabIndex=0,a.appendChild(o),t.appendChild(a)}},fillReviewsHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.reviews,t=document.getElementById("reviews-container"),n=document.createElement("h3");if(n.innerHTML="Reviews",n.tabIndex=0,t.appendChild(n),!e){var a=document.createElement("p");return a.innerHTML="No reviews yet!",void t.appendChild(a)}n.insertAdjacentElement("afterend",document.getElementById("review_form"));var r=document.getElementById("reviews-list");e.forEach(function(e){r.appendChild(createReviewHTML(e))}),t.appendChild(r)},createReviewHTML=function(e){var t=document.createElement("li");t.tabIndex=0;var n=document.createElement("div");n.setAttribute("id","head");var a=document.createElement("p");a.setAttribute("class","alignLeft"),a.innerHTML=e.name,n.appendChild(a);var r=document.createElement("p");r.setAttribute("class","alignRight");var o=new Date(e.createdAt);r.innerHTML=o.toDateString().substring(o.toDateString().indexOf(" ")+1),n.appendChild(r),t.appendChild(n);var i=document.createElement("div");i.setAttribute("id","bottom");var s=document.createElement("p"),c=document.createElement("span");s.setAttribute("class","rating"),c.innerHTML="Rating: "+e.rating,s.appendChild(c),i.appendChild(s);var l=document.createElement("p");l.innerHTML=e.comments,i.appendChild(l),t.appendChild(i);var u=e.name+" reviewed on "+e.date+" with rating of "+e.rating+" and provided his comment "+e.comments;return t.setAttribute("aria-label",u),t},fillBreadcrumb=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,n.tabIndex=0,n.setAttribute("aria-current","page"),t.appendChild(n)},getParameterByName=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null};document.getElementById("review-form").addEventListener("submit",function(e){e.preventDefault(),isConnected||showToast("Not connected, Review will be uploaded once re-connected!");var t=self.restaurant.id,n=document.getElementById("reviewer-name").value,a=document.getElementById("rating-select"),r={restaurant_id:t,name:n,rating:a=a[a.selectedIndex].value,comments:document.getElementById("txt_comment").value,createdAt:Date.now(),updatedAt:Date.now()};DBHelper.addReview(r).then(function(e){document.getElementById("review-form").reset();var t=document.getElementById("reviews-list");t.insertBefore(createReviewHTML(r),t.childNodes[0])}).catch(function(e){document.getElementById("review-form").reset();var t=document.getElementById("reviews-list");t.insertBefore(createReviewHTML(r),t.childNodes[0])})});var syncData=function(){DBHelper.syncOutBoxData().then(function(e){var t;0<e.length&&(e.forEach((t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(console.info("Syncing OutBox Data: "+JSON.stringify(t)),a=n=void 0,n=t.createdAt,!(-1<Object.keys(t).indexOf("is_favorite"))){e.next=7;break}a=DBHelper.toggleFavBtn(t),e.next=10;break;case 7:return e.next=9,DBHelper.addReview(t);case 9:a=e.sent;case 10:return console.info("Uploaded pending request "+JSON.stringify(a)),e.next=13,DBHelper.clearOutBoxData(n);case 13:a=e.sent,console.info("Removed data from Outbox: "+a);case 15:case"end":return e.stop()}},e,void 0)})),function(e){return t.apply(this,arguments)})),showToast("Your pending request uploaded successfully"))}).catch(function(e){console.error("outBoxData",e.stack)})},isOnline=function(e){var t=void 0;"offline"==e.type&&(console.log("You lost connection."),isConnected=!(t="You lost connection.")),"online"==e.type&&(console.log("You are now online."),t="You are now online.",isConnected=!0,syncData()),showToast(t)},showToast=function(e){Snackbar.show({text:e,actionText:"OK",actionTextColor:"#f44336",textColor:"#fff",pos:"bottom-center"})};window.addEventListener("online",isOnline),window.addEventListener("offline",isOnline);